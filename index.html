<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GrumpyLinks â€” AI Powered Pain Point Discovery</title>
<script src="env-config.js"></script>
<style>
:root{
  /* Base */
  --bg:#ffffff; --ink:#37352f; --muted:#787774;
  --border:#e9e9e7; --hover:#f1f1ef; --subtle:#f7f6f3;

  /* Surfaces */
  --sidebar:#f6f7f9;   /* slightly darker than before for contrast */
  --chip:#eef1f6;
  --card:#ffffff;

  /* Accent and states */
  --accent:#2383e2; --success:#448361; --warning:#d9730d; --danger:#e03e3e;

  /* Shadows */
  --shadow:rgba(15,15,15,.06) 0 1px 2px, rgba(15,15,15,.06) 0 0 0 1px;
  --shadow-lg:rgba(15,15,15,.08) 0 8px 24px;

  /* Platforms */
  --reddit:#ff4500; --linkedin:#0077b5; --quora:#b92b27; --medium:#000; --twitter:#1da1f2;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif}
body{background:var(--bg);color:var(--ink);line-height:1.5}

.app{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{
  width:272px;background:var(--sidebar);border-right:1px solid var(--border);
  padding:16px 14px;overflow-y:auto;flex-shrink:0
}
.logo{font-weight:700;font-size:16px;padding:10px 12px;border-radius:8px;background:var(--chip);color:var(--ink);margin-bottom:16px;box-shadow:var(--shadow)}
.nav-section{margin-bottom:18px}
.nav-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin:0 0 8px 6px}

/* Sidebar controls with higher contrast */
.search-input{
  width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;
  font-size:14px;transition:box-shadow .15s,border-color .15s
}
.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(35,131,226,.15)}
.search-btn{
  width:100%;margin-top:8px;padding:10px 12px;border:0;border-radius:8px;background:var(--accent);color:#fff;
  font-weight:600;cursor:pointer;transition:filter .15s
}
.search-btn:hover{filter:brightness(.93)}

.filter-select{
  width:100%;padding:9px 12px;margin-bottom:8px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:14px
}

/* Sidebar links (clear active and hover state) */
.sidebar a, .power-query{
  display:flex;align-items:center;gap:10px;width:100%;padding:8px 10px;border-radius:8px;
  text-decoration:none;color:var(--ink);background:transparent;border:0;cursor:pointer
}
.sidebar a{color:var(--muted)}
.sidebar a:hover{background:#e9eef7;color:var(--ink)}
.sidebar a.active{background:#dfe9fb;color:#0f3b78;font-weight:600;box-shadow:var(--shadow)}

.power-query:hover{background:var(--hover)}
.power-query.active{background:#dfe9fb;color:#0f3b78;font-weight:600}

.query-title{font-weight:600}
.query-desc{font-size:12px;color:var(--muted)}

/* Main area */
.main{flex:1;display:flex;flex-direction:column}
.topbar{
  position:sticky;top:0;background:var(--bg);z-index:10;border-bottom:1px solid var(--border)
}

/* Micro summary bar replaces the old big analysis area */
.micro-summary{
  display:flex;align-items:center;gap:10px;padding:10px 14px
}
.micro-dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
.micro-text{font-size:13px;color:var(--muted)}
.micro-actions{margin-left:auto;display:flex;gap:8px}
.micro-chip{
  font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border)
}

/* Board header */
.board-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 16px 8px 16px
}
.h1{font-size:18px;font-weight:700;margin:0}
.hint{font-size:13px;color:var(--muted)}

/* Content */
.content{padding:8px 16px 24px 16px}

/* Results grid and cards */
.results-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px
}
.result-card{
  background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;box-shadow:var(--shadow);transition:transform .1s
}
.result-card:hover{transform:translateY(-2px)}
.result-meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-bottom:6px}
.badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--subtle);font-size:11px}
.badge.reddit{border-color:var(--reddit);color:var(--reddit)}
.badge.linkedin{border-color:var(--linkedin);color:var(--linkedin)}
.badge.quora{border-color:var(--quora);color:var(--quora)}
.badge.medium{border-color:var(--medium);color:var(--medium)}
.badge.twitter{border-color:var(--twitter);color:var(--twitter)}

.card-title{font-weight:700;margin:6px 0 6px 0}
.card-desc{color:var(--muted);font-size:14px;margin:0 0 10px 0}
.card-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;font-size:13px;cursor:pointer
}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.copy{background:#f8fafc}

/* Empty state */
.empty{
  grid-column:1/-1;border:1px dashed var(--border);border-radius:12px;background:var(--subtle);
  padding:24px;text-align:center;color:var(--muted)
}

/* Mobile */
@media (max-width:980px){
  .sidebar{width:92px;padding:12px}
  .logo{font-size:14px;text-align:center}
  .nav-title{display:none}
  .search-input{display:none}
  .search-btn{display:none}
  .filter-select{display:none}
  .power-query .query-desc{display:none}
  .results-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">ðŸ˜  GrumpyLinks</div>

    <div class="nav-section">
      <div class="nav-title">Search</div>
      <input id="searchInput" class="search-input" type="text" placeholder="Brand, product, or topicâ€¦" />
      <button id="searchBtn" class="search-btn">Search</button>
    </div>

    <div class="nav-section">
      <div class="nav-title">Power queries</div>
      <div id="powerQueries"></div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Filters</div>
      <select id="platformSelect" class="filter-select" title="Choose a site family">
        <option value="all">All platforms</option>
        <option value="reddit">Reddit</option>
        <option value="linkedin">LinkedIn</option>
        <option value="quora">Quora</option>
        <option value="medium">Medium</option>
        <option value="twitter">Twitter</option>
      </select>
      <select id="timeSelect" class="filter-select" title="Time range">
        <option value="">Any time</option>
        <option value="d7">Past week</option>
        <option value="m1">Past month</option>
        <option value="y1">Past year</option>
      </select>
    </div>

    <div class="nav-section">
      <a href="#" class="active">Board</a>
      <a href="#">Timeline</a>
      <a href="#">Reports</a>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Micro summary header -->
    <div class="topbar">
      <div class="micro-summary" id="microSummary" aria-live="polite">
        <span class="micro-dot"></span>
        <span class="micro-text" id="microText">AI summary will appear here after your search</span>
        <div class="micro-actions">
          <span class="micro-chip" id="microScore">Score â€”</span>
        </div>
      </div>
    </div>

    <div class="board-header">
      <h1 class="h1">Results</h1>
      <div class="hint" id="resultCount">0 items</div>
    </div>

    <section class="content">
      <div id="resultsGrid" class="results-grid">
        <div class="empty">Search for a brand or topic to see cards with AI analysis</div>
      </div>
    </section>
  </main>
</div>

<script>
/* ========= Config ========= */
const API_CONFIG = {
  GOOGLE_API_KEY: window.ENV?.GOOGLE_API_KEY || '',
  SEARCH_ENGINE_ID: window.ENV?.SEARCH_ENGINE_ID || '',
  LAMBDA_ENDPOINT: window.ENV?.LAMBDA_ENDPOINT || ''
};

/* ========= Power queries ========= */
const POWER_QUERIES = [
  { title:"Complaints",  desc:"Find recent user pain on forums",    build:(k)=>`${k} complaints OR issues OR problems` },
  { title:"Refunds",     desc:"People asking for refunds",          build:(k)=>`${k} refund OR refund policy OR chargeback` },
  { title:"Shipping",    desc:"Late or broken deliveries",          build:(k)=>`${k} shipping delay OR damaged package` },
  { title:"Support",     desc:"Customer service friction",          build:(k)=>`${k} customer support wait time OR cannot reach support` },
  { title:"Bugs",        desc:"Busted features",                    build:(k)=>`${k} bug OR not working OR broken` }
];

/* ========= App state ========= */
let lastKeyword = "";
let lastResults = [];

/* ========= Init ========= */
init();
function init(){
  renderPowerQueries();
  document.getElementById('searchBtn').addEventListener('click', onSearchClick);
  document.getElementById('platformSelect').addEventListener('change', onSearchClick);
  document.getElementById('timeSelect').addEventListener('change', onSearchClick);
  const saved = localStorage.getItem('grumpy:last');
  if(saved){
    const {k,p,t} = JSON.parse(saved);
    document.getElementById('searchInput').value = k;
    document.getElementById('platformSelect').value = p;
    document.getElementById('timeSelect').value = t;
    runSearch(k,p,t);
  }
}

function renderPowerQueries(){
  const wrap = document.getElementById('powerQueries');
  POWER_QUERIES.forEach(q=>{
    const btn = document.createElement('button');
    btn.className = 'power-query';
    btn.innerHTML = `<div><div class="query-title">${q.title}</div><div class="query-desc">${q.desc}</div></div>`;
    btn.addEventListener('click', ()=>{
      const k = document.getElementById('searchInput').value.trim();
      if(!k) return;
      runSearch(q.build(k), document.getElementById('platformSelect').value, document.getElementById('timeSelect').value);
      document.querySelectorAll('.power-query').forEach(el=>el.classList.remove('active'));
      btn.classList.add('active');
    });
    wrap.appendChild(btn);
  });
}

/* ========= Search ========= */
function onSearchClick(){
  const k = document.getElementById('searchInput').value.trim();
  if(!k) return;
  runSearch(k, document.getElementById('platformSelect').value, document.getElementById('timeSelect').value);
}

async function runSearch(keyword, platform, timeRange){
  lastKeyword = keyword;
  localStorage.setItem('grumpy:last', JSON.stringify({k:keyword,p:platform,t:timeRange}));

  const query = applyPlatformFilter(keyword, platform);
  try{
    const raw = await googleCSE(query, timeRange);
    // Normalize to a simple array of {title, link, snippet, source}
    const items = (raw||[]).map(it=>{
      const host = safeHost(it.link);
      const source = host.includes('reddit')?'reddit'
                   :host.includes('linkedin')?'linkedin'
                   :host.includes('quora')?'quora'
                   :host.includes('medium')?'medium'
                   :host.includes('twitter')?'twitter'
                   :'web';
      return {title:it.title, link:it.link, snippet:it.snippet||'', source};
    });

    lastResults = items;

    updateCount(items.length);
    renderCards(items);

    // Ask Lambda for card level ideas
    const analysis = await analyzeWithAI(items, keyword, platform);
    applyMicroSummary(analysis);
    mergeOpportunitiesIntoCards(analysis);

  }catch(err){
    console.error(err);
    updateCount(0);
    document.getElementById('resultsGrid').innerHTML =
      `<div class="empty">Search failed. ${err.message || 'Try again.'}</div>`;
  }
}

function applyPlatformFilter(keyword, platform){
  if(platform==='all') return keyword + ' site:reddit.com OR site:quora.com OR site:linkedin.com OR site:medium.com OR site:twitter.com';
  const site =
    platform==='reddit'   ? 'site:reddit.com'   :
    platform==='linkedin' ? 'site:linkedin.com' :
    platform==='quora'    ? 'site:quora.com'    :
    platform==='medium'   ? 'site:medium.com'   :
    platform==='twitter'  ? 'site:x.com OR site:twitter.com' : '';
  return `${keyword} ${site}`;
}

async function googleCSE(q, timeRange){
  if(!API_CONFIG.GOOGLE_API_KEY || !API_CONFIG.SEARCH_ENGINE_ID){
    throw new Error('Google search is not configured');
  }
  const params = new URLSearchParams({
    key:API_CONFIG.GOOGLE_API_KEY,
    cx:API_CONFIG.SEARCH_ENGINE_ID,
    q:q,
    num:'10'
  });
  if(timeRange) params.set('dateRestrict', timeRange);
  const r = await fetch(`https://www.googleapis.com/customsearch/v1?${params.toString()}`);
  if(!r.ok) throw new Error('Search request failed');
  const data = await r.json();
  return data.items || [];
}

/* ========= Lambda analysis ========= */
async function analyzeWithAI(results, query, platform){
  if(!API_CONFIG.LAMBDA_ENDPOINT){
    return { mainPainPoint:"AI analysis not configured", resultInsights:[], overallOpportunityScore:3, topActionableIdeas:[] };
  }
  const r = await fetch(API_CONFIG.LAMBDA_ENDPOINT.replace(/\/$/,'') + '/analyze', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ query, platform, results })
  });
  if(!r.ok) throw new Error('AI analysis failed');
  return await r.json();
}

/* ========= UI helpers ========= */
function updateCount(n){
  document.getElementById('resultCount').textContent = `${n} item${n===1?'':'s'}`;
}

function applyMicroSummary(analysis){
  // Compact one liner
  const text = analysis?.mainPainPoint
    ? analysis.mainPainPoint
    : 'No clear pattern yet';
  document.getElementById('microText').textContent = `AI summary: ${text}`;

  const score = Number(analysis?.overallOpportunityScore||0);
  const chip = document.getElementById('microScore');
  if(score){
    chip.textContent = `Score ${score}/10`;
  }else{
    chip.textContent = 'Score â€”';
  }
}

function renderCards(items){
  const grid = document.getElementById('resultsGrid');
  if(!items.length){
    grid.innerHTML = `<div class="empty">No results. Try a broader term.</div>`;
    return;
  }
  const html = items.map((it,idx)=>`
    <article class="result-card" data-title="${escapeHtml(it.title)}">
      <div class="result-meta">
        <span class="badge ${it.source}">${it.source}</span>
        <span>${safeHost(it.link)}</span>
      </div>
      <h3 class="card-title">${escapeHtml(it.title)}</h3>
      <p class="card-desc">${escapeHtml(it.snippet)}</p>
      <div id="opp-${idx}" class="card-desc" style="display:none;"></div>
      <div class="card-actions">
        <a class="btn primary" href="${it.link}" target="_blank" rel="noopener">Open</a>
        <button class="btn copy" onclick="copyToClipboard('${escapeAttr(it.link)}')">Copy link</button>
      </div>
    </article>
  `).join('');
  grid.innerHTML = html;
}

function mergeOpportunitiesIntoCards(analysis){
  const insights = analysis?.resultInsights || [];
  if(!insights.length) return;

  // Map by title with loose matching to avoid Tom Cruise type false hits
  const norm = s => s.toLowerCase().replace(/[^a-z0-9 ]/g,'').slice(0,120);
  const byTitle = new Map(insights.map(x=>[norm(x.title||''), x]));

  document.querySelectorAll('.result-card').forEach((card,idx)=>{
    const t = norm(card.getAttribute('data-title') || '');
    const match = byTitle.get(t);
    if(match && match.businessOpportunity){
      const slot = document.getElementById(`opp-${idx}`);
      slot.style.display = 'block';
      slot.innerHTML = `<strong>Idea:</strong> ${escapeHtml(match.businessOpportunity)} <span class="badge">${escapeHtml(match.urgency||'')}</span>`;
    }
  });
}

/* ========= Utils ========= */
function safeHost(url){
  try{ return new URL(url).hostname.replace(/^www\./,''); }catch{ return '' }
}
function copyToClipboard(text){
  navigator.clipboard?.writeText(text);
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escapeAttr(s){ return (s||'').replace(/['"\\]/g, m => ({'"':'&quot;',"'":'&#39;','\\':'\\\\'}[m])); }
</script>
</body>
</html>
